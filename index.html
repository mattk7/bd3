<html>

    <head>
        <script src="./libs/jquery-1.11.1.min.js"></script>
        <script src="./libs/d3.min.js"></script>
        <script src="./libs/ui.js"></script>    
        <link href="./css/styles.css" rel="stylesheet" />
    </head>    
    <body>
        <div id="header">
			<div id="title">
				<h2>Olympinomics</h2>
			</div>
            <div id="menu">
                <div class="varSelects">
                  <span class="selectTitle">Upper Graph</span>                  
                  <select id="TopVariable"></select>
                  <span class="selectTitle">Lower Graph</span>
                  <select id="BottomVariable"></select>
                  <span class="selectTitle">Gender</span>
                  <label><input type="checkbox" value="Female" checked>Female</label> 
                  <label><input type="checkbox" value="Male" checked>Male</label>
                </div>
            </div>
		</div>
        <svg></svg>
        <script>
            var XScreen = window.screen.availWidth
            var YScreen = window.screen.availHeight
            var MarginPct = 0.025
            var xMargin = MarginPct*XScreen
            var yMargin = MarginPct*YScreen+60
            
            var FigureWidth = XScreen - 2*xMargin
            var FigureHeight = YScreen - 2*yMargin
            
            var upVar = "GNI per capita, PPP (current international $)";
            var downVar = 'Female_Silver';
            
            
            d3.json('./Data/data_joined.json', function(json_data){
                    var data = d3.entries(json_data);

            function update(upVar, downVar) {          
                         data.sort(function(a, b){
                             return d3.descending(a.value[upVar] || 0, b.value[upVar] || 0)
                         }) 

                    console.log(data);

                    var svg = d3.select('svg')
                        .attr('width', FigureWidth)
                        .attr('height', FigureHeight)
                        .selectAll('g')
                        .data(data, function(d){return d.key;})
                        //.data(data)

                    var groups = svg.enter()
                                .append('g')

                    var upMin = d3.min(data, function(d){
                        return d.value[upVar] || 0;  
                    })                

                    var upMax = d3.max(data, function(d){
                        return d.value[upVar] || 0;  
                    })                

                    var downMin = d3.min(data, function(d){
                        return d.value[downVar] || 0;  
                    })                

                    var downMax = d3.max(data, function(d){
                        return d.value[downVar] || 0;  
                    })                

                    var lenRange = FigureHeight/2;

                    var upMap = d3.scale.linear()
                                    .domain([upMin, upMax])
                                    .range([0, lenRange]);

                    var downMap = d3.scale.linear()
                                    .domain([downMin, downMax])
                                    .range([0, lenRange]);
                    var startY = lenRange*0.99;
                    var startX = 10+xMargin;
                    var barWidth = Math.floor(FigureWidth/data.length);

                    var upRect = groups
                        .append('rect')
                        .attr('transform', function(d, i){return 'translate(' + i*startX*0 + ',' + startY + ')'; })
                        .attr("y", function(d) { return -upMap(d.value[upVar] || 0); })
                        .attr("class", "up")

                    var downRect = groups
                        .append('rect')
                        .attr('transform', function(d, i){return 'translate(' + i*startX*0 + ',' + startY + ')'; })
                        .attr("class", "down")
                    
                    var upLabel = groups
                        .append("text")
                        .attr("class", "upperLabel")
                    
                    var downLabel = groups
                        .append('text')
                        .attr("class", "lowerLabel")

                    svg
                        .exit()
                        .remove()                      

                    svg.select('.up')
                        .attr("fill", "#FE9900")
                        .attr("x", startX)
                        .attr("width", barWidth)
                        .attr("opacity", 0.8)                    
                        .attr("id", function(d) { return d.key; })
                        .transition()
                        .duration(1000)
                        .attr('transform', function(d, i){return 'translate(' + i*barWidth + ',' + startY + ')'; })
                        .attr("height", function(d) { return upMap(d.value[upVar] || 0); })
                        .attr("y", function(d) { return -upMap(d.value[upVar] || 0); })


                    svg.select('.down')
                        .attr("fill", "#514554")
                        .attr("x", startX)
                        .attr("width", barWidth)
                        .attr("opacity", 0.8)
                        .attr("id", function(d) { return d.key; })
                        .transition()
                        .duration(1000)
                        .attr('transform', function(d, i){return 'translate(' + i*barWidth + ',' + startY + ')'; })
                        .attr("height", function(d) { return downMap(d.value[downVar] || 0); })
                    
                    svg.select('.upperLabel')
                        .text(upVar)
                        .attr("dy", ".71em")
                        .attr("y", '40%')
                        .attr("x", '70%');
                
                    svg.select('.lowerLabel')
                        .text(downVar)
                        .attr("dy", ".71em")
                        .attr("y", '60%')
                        .attr("x", '70%');


                return [upVar, downVar]

            }
                
            var Vars = update(upVar, downVar);
            console.log(Vars);
            
            d3.select('#btn')
                .on('click', function(){
                     Vars = update(Vars[1], Vars[0])
                     console.log(Vars);
                })

            
            d3.select("#TopVariable").on("change", function(){                                    
                                         Vars = update(d3.event.target.value, Vars[1])                                        
                                    });
            
            d3.select("#BottomVariable").on("change", function(){                                    
                                         Vars = update(Vars[0] , d3.event.target.value)                                        
                                    });
            });
        </script>
    </body>
</html>