<html>
    <head>
        <script src="d3.min.js"></script>
        <title>Stacked Weight</title>
        
        <style>
            .stack{
                border: 1px solid #555;
            }
        </style>
        

    </head>
    <body>
        <svg class='stack'>
        </svg>
        <div id=buttons></div>
        
        <script>
            // This looks like a good example: http://bl.ocks.org/mbostock/3020685
            
            
            // Select the first (and hopefully the only) <svg class="stack"> element
            var svg = d3.select('svg.stack');
            
            var h = 400; // canvas height
            var w = 600; // canvas width
            
            svg.attr('height',h)
            svg.attr('width',h)
            
            // stack graph logic here
            
                var data = d3.csv('data/hist.csv', function(data){
                
                // And then was the data...
                data.forEach(function(d){ 
                    d.x = +d.x; // casting to integer
                    d.y = +d.y; // casting to integer
                });
                    
                var sportWeight = d3.nest()
                    .key(function(d){
                        return d.Sport;
                    })
                    .entries(data);
                
                //sportWeight.forEach.remove(Sport)
                
                console.log(sportWeight);
                
                minWeight = d3.min(data, function(d){
                    return d.x;
                });
                
                maxWeight = d3.max(data, function(d){
                    return d.x;
                });
                
                console.log([minWeight, maxWeight]);
                
                //FIXIT!!!
                mapx = d3.scale.linear()
                    .domain([30,150])
                    .range([0,w])
                
                maxCount = d3.max(data, function(d){
                    return d.y;
                });
                
                console.log(maxCount)
                
                // FIXIT!
                mapy = d3.scale.linear()
                    //.domain([0,maxCount])
                    .domain([0,1500])
                    .range([0,h])
                
                var stack = d3.layout.stack()
                    .offset("zero")
                    .values(function(d){
						return d.values;
					})
                
                // transform the dataset
                var weightStack = stack(sportWeight);
                
                console.log(weightStack)

                // create the area path generator
                var area = d3.svg.area()
                    .interpolate("cardinal")
                    .x(function(d) { return mapx(d.date); })
                    .y0(function(d) { return mapy(d.y0); })
                    .y1(function(d) { return mapy(d.y0 + d.y); });
                    

                var area = d3.svg.area()
                            .x(function(d){
                                return mapx(d.x);
                            })
                            .y0(function(d){
                                return mapy(d.y0);
                            })
                            .y1(function(d){
                                return mapy(d.y)+mapy(d.y0);
                            })
                            .interpolate('monotone')

                // some colors
                var cols = d3.scale.category20()


                // draw the paths
                var graph = svg.selectAll('path')
                    .append('g')
                    .attr('class', 'stack')
                    //.attr('transform',)
                    .data(weightStack)
                    .enter()
                    .append('path')
                    .attr('d', function(d){
                        return area(d.values);
                    })
                    .style('fill', function(d, i){
                        return cols(i)
                    })
						
                

                var format = d3.format('.2f')

                var axisX = d3.svg.axis()
                    .scale(mapx)
                    .ticks(5)
                    .tickSize(1)
                    .tickSubdivide(true)
                    .tickFormat(format)

                var axisY = d3.svg.axis()
                    .scale(mapy)
                    .orient('right')
                    .ticks(5)
                    .tickSize(1)
                    .tickSubdivide(true)
                    .tickFormat(format)


                svg.append('g').call(axisX)
                svg.append('g').call(axisY)
            
            
            ///////////////////////////////////
            
            // Importing the data from scratch
            });
            var data = d3.csv('data/olympics_2012_clean.csv', function(data){
            ///////////////
                var data_by_sport = d3.nest()
                    .key(function(d){
                        return d.Sport;
                    })
                    .entries(data)
                
                function update_widgets(widget_sports){
                    console.log(widget_sports)
                    // Select all present and future <g class="widget"> objects
                    var widgets = svg.selectAll('g.widget')
                        .data(widget_sports)

                    // if widget exists in the canvas and we don't want it anymore
                    widgets.exit()
                        .remove()

                    // if not exists then create
                    widgets.enter()
                        .append('g')
                        .attr('class', 'widget')

                    // Append a nice rectangle in every widget
                    widgets.append('rect')
                        .attr('width', 50)
                        .attr('height', 20)
                        .attr('fill', 'orange')
                }
            
                // This array contains the objects representing the nations the user selected.
                var widget_sports = []
                
                d3.select('#buttons')
                    .selectAll('button.widget_trigger')
                    .data(data_by_sport)
                    .enter()
                    .append('button')
                    .attr('class', 'widget_trigger')
                    .attr('id', function(d){
                        return d.key
                    })
                    .text(function(d){
                        return d.key
                    })
                
                d3.select('#buttons')
                    .selectAll('button.widget_reset')
                    .data(['Reset'])
                    .enter()
                    .append('button')
                    .attr('class', 'widget_reset')
                    .text(function(d){
                        return d
                    })
                
                d3.selectAll('.widget_trigger')
                    .on('click', function(){
                        var sport = this.id
                        selected_data = data_by_sport
                            .filter(function(d){
                                return (d.key == sport )
                            }).pop()
                        var i = widget_sports.indexOf(selected_data) // Look for nation in array.
                        if (i > -1) {                                 // If nation in array...
                            widget_sports.splice(i, 1)               // ... pop it out.
                        } else {
                            widget_sports.push(selected_data)        // else push new nation in array.
                        }
                        update_widgets(widget_sports)       // Update widget view
                        })

                d3.select('.widget_reset')
                    .on('click', function(){
                        widget_sports = []
                        update_widgets(widget_sports)
                        })
                });
        </script>
    </body>
</html>
